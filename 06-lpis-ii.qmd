---
title: "LPIS data II"
format: html
editor: visual
---

## Priprava prostredi

Nejprve nactete knihovny `tidyverse`, `janitor` a `readxl`.

```{r setup}
require(tidyverse)
require(janitor)
require(readxl)

```

Nactete data ze souboru xlsx pro rok 2020.

```{r nacteni-dat}
data <- read_xlsx("data/Verejny_LPIS_201231.xlsx") |> 
  clean_names()
```

Nactete ciselnik kodu a nazvu okresu.

```{r nacteni-ciselnik-okresy}
okresy <- read_xlsx("data/Kody_a_nazvy_okresu_CR.xlsx") |> 
  clean_names()
```

Pouzijte ciselnik okresu pro pripojeni nazvu okresu ke zdrojove tabulce LPIS.

```{r pripojeni-okresu}
data <- data |> 
  left_join(okresy, by = "okres_kod")
```

## Analyza dat

Spocitejte pocet uzivatelu a pocet katastralnich uzemi v okrese Pardubice (funkce `n_distinct`).

```{r pocty-pardubice}
data |> 
  filter(okres_nazev == "Pardubice") |> 
  summarise(n = n(),
            poc_uz = n_distinct(id_uz),
            poc_ku = n_distinct(ku_kod))
```

Seradte okresy podle (vazene dle vymery) prumerne nadmorske vysky. Vyberte pouze okresy s prumernou nadmorskou vyskou alespon 550 mnm.

```{r nejvyse-polozene-okresy}
data |> 
  group_by(okres_nazev) |> 
  summarise(vysk = weighted.mean(vysk, vymera)) |> 
  filter(vysk >= 550) |> 
  arrange(desc(vysk))
```

Najdete uzivatele, ktery ma pozemky v nejvice okresech. Jake okresy to jsou?

```{r uzivatel-nejvice-okresu}
data |> 
  group_by(id_uz) |> 
  summarise(poc_okresu = n_distinct(okres_kod)) |> 
  arrange(-poc_okresu) |> 
  head(1) |> 
  pull(id_uz)
```

```{r}
id_uz_nejvice <- data |> 
  group_by(id_uz, okres_nazev) |> 
  summarise(.groups = "drop") |> 
  group_by(id_uz) |> 
  summarise(pocet_okresu = n()) |> 
  filter(pocet_okresu == max(pocet_okresu)) |> 
  pull(id_uz)
```

```{r}
data |> 
  group_by(id_uz, okres_nazev) |> 
  summarise(.groups = "drop") |> 
  group_by(id_uz) |> 
  mutate(pocet_okresu = n()) |> 
  ungroup() |> 
  filter(pocet_okresu == max(pocet_okresu))
```

```{r}
data |> 
  distinct(id_uz, okres_nazev) |> 
  count(id_uz)
```

```{r}
data |> 
  filter(id_uz == id_uz_nejvice) |> 
  group_by(okres_nazev) |> 
  summarise()
```

```{r}

```

Vyfiltrujte z dat pouze takova katastralni uzemi, ktera maji nadprumernou nadmorskou vysku a vymeru alespon jeden hektar (zalezi na poradi techto podminek). Z techto uzemi vyberte 10 s nejmensim sklonem svahu. V jakem okrese se jich nachazi nejvice?

```{r nizky-sklon-vysoko}

```

Vyberte katastralni uzemi s podilem zorneni (`kultura` mezi 1 a 7) nad 99 %. Kolik takovych uzemi je?

```{r podil-zorneni}

```

Rozdelte uzivatele na male, stredni a velke (stejne posty uzivatel v obou skupinach). Jaky je podil rybniku (`kultura == 97`) na celkove vymere v jednotlivych skupinach?

```{r}

```

## Vizualizace

Spocitejte podilne zastoupeni (dle vymery) jednotlivych kultur v okresech Jihlava a Sokolov. Podily vykreslete do grafu dle vlastniho uvazeni.

Navic: Nektere skupiny jsou tak male, ze je nema smysl vykreslovat do grafu. Napada vas, jak tento problem vyresit? Napr. sloucenim podobnych kategorii, nebo vytvorenim skupiny "Ostatni".

```{r srovnani-jihlava-sokolov}
data |> 
  filter(okres_nazev %in% c("Jihlava", "Sokolov")) |> 
  group_by(okres_nazev, kulturanaz) |> 
  summarise(vymera = sum(vymera), .groups = "drop") |> 
  group_by(okres_nazev) |> 
  mutate(vymera_podil = vymera / sum(vymera)) |> 
  ggplot(aes(okres_nazev, vymera_podil,
             fill = kulturanaz, color = kulturanaz)) +
  geom_col(alpha = 0.3)
```

Pro kazdy okres spocitejte prumernou nadmorskou vysku a podil trvale travnateho porostu (`kulturakod == "T"`). Vykreslete graf zavislosti techto dvou velicin. Prolozte graf regresni primkou.

```{r ku-vyska-porost}
data |> 
  select(okres_nazev, vymera, kulturakod, vysk) |> 
  mutate(vymera_tp = ifelse(kulturakod == "T", vymera, 0)) |> 
  #   mutate(vumera_tp = (kulturakod == "T") * vymera) |> 
  group_by(okres_nazev) |> 
  summarise(vysk = weighted.mean(vysk, vymera),
            vymera = sum(vymera),
            vymera_tp = sum(vymera_tp)) |> 
  mutate(podil_tp = vymera_tp / vymera) |> 
  ggplot(aes(vysk, podil_tp)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x)
```

Stejny graf vygenerujte pro okresy. Graf prolozte regresni primkou.

Extra: Vyznacte jinou barvou okresy ze stredoceskeho kraje (NUTS4 zacina kodem CZ02). Je podil travnatych porostu vyssi nebo nizsi nez je ocekavani podle nadmorske vysky?

```{r okres-vyska-porost}

```

Naznacte rozdeleni (distribuci) velikosti katastralnich uzemi pro jednotlive okresy.

```{r rozdeleni-vymer}

```
